<!-- Page Title -->
<% title "عرض الحالة" %>

<!-- Script src for Google map -->
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDY0kkJiTPVd2U7aTOAwhc9ySH6oHxOIYM&sensor=false"></script>


<div class="request_content">

  <!-- Notice Message -->
  <div data-alert class="alert-box success radius">
    <%= notice %>
    <a href="#" class="close">&times;</a>
  </div>

  <div class="row main_data" data-equalizer>

    <div class="column medium-2" style="position:relative;" data-equalizer-watch>
      <!-- Request DueDate -->
      <div class="due-date">
        <p><%= @request.due_date.strftime("%d/%m") %></p>
      </div>
    </div>

    <div class="column medium-10" data-equalizer-watch>

      <!-- Request ID -->
      <h1>
        <b>طلب رقم:</b>
        <%= @request.id.to_s.split[1,6] %>
      </h1>

      <!-- Request State -->
      <h1>
        <b>حالة الطلب:</b>
        <%= @request.state %>
      </h1>

    </div>

  </div>

  <div class="row">
   
    <div class="column large-6">

      <!-- Request BloodType -->
      <h2>فصيلة الدم:</h2>
      <p><%= @request.blood_type %></p>
    </div>

    <div class="column large-6">

      <!-- Request # of BloodBags -->
      <h2>عدد أكياس الدم:</h2>
      <p><%= @request.blood_bags %></p>
    </div>

  </div>

  <div class="row">

    <div class="column medium-6">
      
      <!-- Required BloodType -->
      <h2>الفصيلة المطلوبة:</h2>
      <p><%= @request.req_type %></p>
    </div>

    <div class="column medium-6">

      <!-- Hospital Address -->
      <h2>عنوان المستشفى:</h2>
      <p><%= @request.hospital_address %></p>
    </div>

  </div>

  <div class="row more">
    
    <div class="more-content column small-3 small-centered">

      <div class="more-patient-details">

        <!-- Link to more Requst info. Popup -->
          <a href="#" class="reveal-link" data-reveal-id="patientContact" >تفاصيل التواصل</a> | 
      </div>

      <div class="share-patient-social">
        
        <!-- Social Media Sharing Buttons -->
         <h2>مشاركة</h2>

         <!-- Facebook share -->
         <a href="https://www.facebook.com/sharer/sharer.php?u=<%= request.original_url %>"><li class="fa fa-facebook"></li></a>

         <!-- Twitter share -->
         <a href="https://twitter.com/intent/tweet?url=<%= request.original_url %>"><li class="fa fa-twitter"></li></a>

         <!-- G+ share -->
         <a href="https://plus.google.com/share?url=<%= request.original_url %>"><li class="fa fa-google-plus"></li></a>
      </div>

    </div>
             
  </div>


  <!-- More Request info. Popup -->
  <div id="patientContact" class="reveal-modal" data-reveal>
    
    <!-- Request info. in case of signed users -->
    <% if user_signed_in? %>

      <div class="row">

        <div class="column medium-6">
          
          <!-- Contact Name -->
          <p>
            <b>اسم صلة التواصل:</b>
            <%= @request.contact_name %>
          </p>
        </div>

        <div class="column medium-6">
          
          <!-- Contact Phone -->
          <p>
            <b>رقم التليفون:</b>
            <%= @request.contact_phone %>
          </p>
        </div>
      </div>

      <div class="row">

        <div class="column medium-6">

          <!-- Patient Name -->
          <p>
            <b>اسم المريض:</b>
            <%= @request.patient_name %>
          </p>
        </div>

        <div class="column medium-6">

          <!-- Hospital Phone -->
          <p>
            <b>رقم المستشفى:</b>
            <%= @request.hospital_phone %>
          </p>
        </div>

      </div>

      <div class="row">
        <div class="column small-12">

          <!-- Hospital Address -->
          <b>عنوان المستشفى</b>
          <%= @request.hospital_address %>
        </div>

        <div class="column small-12">
          
          <!-- Hospital Address on map -->
          <div id="map_canvas" style="width:100%; height:300px; margin: 10px 0;"></div>

        </div>

        <!-- Google map Script -->
        <script type="text/javascript">

          function initialize()
          {
          var mapProp = {
            center:new google.maps.LatLng(<%= @request.longitude %>, <%= @request.latitude %>),
            zoom:10,
            mapTypeId:google.maps.MapTypeId.ROADMAP
            };
          var map=new google.maps.Map(document.getElementById("map_canvas"),mapProp);
          }

          google.maps.event.addDomListener(window, 'load', initialize);
                  
        </script>

      </div>

    <!-- In case of visitors -->
    <% else %>

      <div class="row">

         <div class="column small-8 small-centered alert" style="text-align:center;">
           <p>عذراً، تفاصيل التواصل متاحة للمسجلين فقط.</p>
         </div>

      </div>

      <div class="row">

        <div class="column medium-6">

          <!-- User signin -->
          <%= link_to "تسجيل متبرع جديد", new_user_path, :class=>"button column small-11" %>
        </div>

        <div class="column medium-6">

          <!-- User signup -->
          <%= link_to "تسجيل دخول متبرع", new_user_session_path, :class=>"button column small-11" %>
        </div>

      </div>

    <%end%>

    <!-- close popup -->
    <a class="close-reveal-modal">&#215;</a>

  </div>
  <!-- End of Popup -->


  <!-- List of Donors for the request -->
  <p>
    <b>المتبرعين</b>

    <%  @replies = Reply.all.where(request: @request) %>
      
      <!-- If there are Donors -->
      <%   if !@replies.empty? %>
        <div class="row " >
          <ul class="small-block-grid-3  donator_confirmations" >

            <!-- Beginning of Donors loop -->
            <% @replies.each do |p| %>
              <li data-equalizer>

                <!-- Donor Name -->
                <div class="column small-6 donator_name panel " data-equalizer-watch>
                    <h2 ><%= p.user.name %></h2><%@user=p.user%>
                </div>

                <!-- Confirm Donation -->
                <div class="column small-6 confirmation" data-equalizer-watch>
                  <%= link_to 'التأكيد',confirm_request_path(@request,:user_id =>@user.id,:reply_id =>p.id, method: :post)%>
                </div>

              </li>
            <%end%>
            <!-- End of Donors Loop -->
          </ul>
         </div>
      
      <!-- if there are no Donors -->
      <%else %>
        لا يوجد متبرعين بعد.
      <% end %>

  </p>

  <div style="float:left">

    <!-- Edit Request -->
    <%= link_to 'تعديل', edit_request_path(@request) %> |

    <!-- Back to Requests list -->
    <%= link_to 'العودة إلى قائمة الطلبات', requests_path %>
  </div>
</div>


<!-- Script for social media share -->
<script type="text/javascript">
  // create social networking pop-ups
  (function() {
      // link selector and pop-up window size
      var Config = {
          Link: ".share-patient-social a",
          Width: 500,
          Height: 500
      };
   
      // add handler links
      var slink = document.querySelectorAll(Config.Link);
      for (var a = 0; a < slink.length; a++) {
          slink[a].onclick = PopupHandler;
      }
   
      // create popup
      function PopupHandler(e) {
   
          e = (e ? e : window.event);
          var t = (e.target ? e.target : e.srcElement);
   
          // popup position
          var
              px = Math.floor(((screen.availWidth || 1024) - Config.Width) / 2),
              py = Math.floor(((screen.availHeight || 700) - Config.Height) / 2);
   
          // open popup
          var popup = window.open(t.href, "social",
              "width="+Config.Width+",height="+Config.Height+
              ",left="+px+",top="+py+
              ",location=0,menubar=0,toolbar=0,status=0,scrollbars=1,resizable=1");
          if (popup) {
              popup.focus();
              if (e.preventDefault) e.preventDefault();
              e.returnValue = false;
          }
   
          return !!popup;
      }
   
  }());
</script>